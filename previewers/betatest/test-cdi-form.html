<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CDI Form Test - Debug</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script type="module" src="js/shacl-form.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            max-width: 1200px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ccc;
            background: #f9f9f9;
        }
        .log {
            background: #fff;
            border: 1px solid #ddd;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        .error { color: red; }
        .success { color: green; }
        .info { color: blue; }
    </style>
</head>
<body>
    <h1>CDI Form Test - Standalone Debug</h1>
    
    <div class="test-section">
        <h2>Test Configuration</h2>
        <p>This test replicates the exact setup used in the CDI previewer.</p>
        <button id="runTest">Run Test</button>
        <button id="clearLog">Clear Log</button>
    </div>

    <div class="test-section">
        <h2>Console Log</h2>
        <div id="log" class="log"></div>
    </div>

    <div class="test-section">
        <h2>Form Container</h2>
        <div id="formContainer"></div>
    </div>

    <script type="module">
        const logDiv = document.getElementById('log');
        
        function log(message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = type;
            entry.textContent = `[${new Date().toISOString().substr(11, 12)}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        document.getElementById('clearLog').addEventListener('click', () => {
            logDiv.innerHTML = '';
        });

        document.getElementById('runTest').addEventListener('click', async () => {
            log('=== STARTING CDI FORM TEST ===', 'info');
            
            try {
                // Load SimpleSample.jsonld
                log('Loading SimpleSample.jsonld...', 'info');
                const dataResponse = await fetch('../../examples/cdi/SimpleSample.jsonld');
                const jsonData = await dataResponse.json();
                log(`Loaded JSON-LD data with ${jsonData['@graph']?.length} nodes`, 'success');

                // Load SHACL shapes
                log('Loading SHACL shapes...', 'info');
                const shapesResponse = await fetch('shapes/CDIF-Discovery-Core-Shapes.ttl');
                let shapesData = await shapesResponse.text();
                log(`Loaded SHACL shapes: ${shapesData.length} characters`, 'success');

                // Wait for custom element
                log('Waiting for shacl-form custom element...', 'info');
                await customElements.whenDefined('shacl-form');
                log('shacl-form custom element is defined', 'success');

                // Create inline context
                const fileUrl = 'http://localhost:8080/api/v1/access/datafile/26';
                const cleanBaseUrl = fileUrl.split('?')[0];
                const inlineContext = {
                    "@base": cleanBaseUrl,
                    "@vocab": "http://ddialliance.org/Specification/DDI-CDI/1.0/RDF/",
                    "schema": "http://schema.org/",
                    "dcterms": "http://purl.org/dc/terms/",
                    "xsd": "http://www.w3.org/2001/XMLSchema#",
                    "rdf": "http://www.w3.org/1999/02/22-rdf-syntax-ns#",
                    "skos": "http://www.w3.org/2004/02/skos/core#",
                    "time": "http://www.w3.org/2006/time#",
                    "spdx": "http://spdx.org/rdf/terms#",
                    "prov": "http://www.w3.org/ns/prov#",
                    "geosparql": "http://www.opengis.net/ont/geosparql#",
                    "WideDataSet": "http://ddialliance.org/Specification/DDI-CDI/1.0/RDF/WideDataSet",
                    "LongDataSet": "http://ddialliance.org/Specification/DDI-CDI/1.0/RDF/LongDataSet",
                    "DimensionalDataSet": "http://ddialliance.org/Specification/DDI-CDI/1.0/RDF/DimensionalDataSet",
                    "PhysicalDataSet": "http://ddialliance.org/Specification/DDI-CDI/1.0/RDF/PhysicalDataSet"
                };

                // Replace context
                if (jsonData['@context'] && typeof jsonData['@context'] === 'string' && 
                    jsonData['@context'].includes('bitbucket.io')) {
                    log('Replacing bitbucket context with inline context', 'info');
                    jsonData['@context'] = inlineContext;
                }

                const valuesString = JSON.stringify(jsonData, null, 2);
                log(`Values string: ${valuesString.length} characters`, 'success');

                // Find dataset node
                const datasets = jsonData['@graph'].filter(node => {
                    const types = Array.isArray(node['@type']) ? node['@type'] : [node['@type']];
                    return types && types.some(t => 
                        t.includes('DataSet') || t.includes('Dataset') || 
                        t === 'WideDataSet' || t === 'LongDataSet' || t === 'DimensionalDataSet'
                    );
                });

                if (datasets.length === 0) {
                    throw new Error('No dataset found in JSON-LD data');
                }

                const datasetId = datasets[0]['@id'];
                log(`Found dataset: ${datasetId}`, 'success');

                // Resolve fragment identifier
                let resolvedId = datasetId;
                if (datasetId.startsWith('#')) {
                    resolvedId = cleanBaseUrl + datasetId;
                    log(`Resolved ${datasetId} to ${resolvedId}`, 'info');
                }

                // Create shacl-form element
                log('Creating shacl-form element...', 'info');
                const shaclFormElement = document.createElement('shacl-form');
                
                // Set attributes
                shaclFormElement.setAttribute('data-shapes', shapesData);
                shaclFormElement.setAttribute('data-values', valuesString);
                shaclFormElement.setAttribute('data-view', 'true');
                shaclFormElement.setAttribute('data-collapse', 'open');
                shaclFormElement.setAttribute('data-shape-subject', 'https://cdif.org/validation/0.1/shacl#CDIFDatasetRecommendedShape');
                shaclFormElement.setAttribute('data-values-subject', resolvedId);
                
                log(`Set data-shape-subject: https://cdif.org/validation/0.1/shacl#CDIFDatasetRecommendedShape`, 'info');
                log(`Set data-values-subject: ${resolvedId}`, 'info');
                log(`All attributes: ${shaclFormElement.getAttributeNames().join(', ')}`, 'info');

                // Add event listeners
                shaclFormElement.addEventListener('shacl-form-ready', () => {
                    log('EVENT: shacl-form-ready', 'success');
                });

                shaclFormElement.addEventListener('change', (event) => {
                    log(`EVENT: change (valid=${event.detail?.valid})`, 'info');
                });

                shaclFormElement.addEventListener('error', (event) => {
                    log(`EVENT: error - ${JSON.stringify(event.detail)}`, 'error');
                });

                // Intercept console
                const originalWarn = console.warn;
                const originalError = console.error;
                const originalInfo = console.info;
                console.warn = function(...args) {
                    log(`WARN: ${args.join(' ')}`, 'error');
                    originalWarn.apply(console, args);
                };
                console.error = function(...args) {
                    log(`ERROR: ${args.join(' ')}`, 'error');
                    originalError.apply(console, args);
                };
                console.info = function(...args) {
                    log(`INFO: ${args.join(' ')}`, 'info');
                    originalInfo.apply(console, args);
                };

                // Append to DOM
                const container = document.getElementById('formContainer');
                container.innerHTML = '';
                container.appendChild(shaclFormElement);
                
                log('Form element appended to DOM', 'success');
                log(`Element connected: ${shaclFormElement.isConnected}`, 'info');
                log(`ShadowRoot exists: ${!!shaclFormElement.shadowRoot}`, 'info');

                // CRITICAL DEBUG: Access the internal store to see what was parsed
                setTimeout(() => {
                    log('=== CHECKING RDF STORE CONTENTS ===', 'info');
                    try {
                        // Access the form's config and store (this is a hack for debugging)
                        const form = shaclFormElement;
                        if (form.config && form.config.store) {
                            const store = form.config.store;
                            const shapeSubject = 'https://cdif.org/validation/0.1/shacl#CDIFDatasetRecommendedShape';
                            
                            // Check if shape exists
                            const shapeQuads = store.getQuads(shapeSubject, null, null, null);
                            log(`Quads for shape subject ${shapeSubject}: ${shapeQuads.length}`, shapeQuads.length > 0 ? 'success' : 'error');
                            
                            if (shapeQuads.length > 0) {
                                log('Shape quads:', 'info');
                                shapeQuads.slice(0, 10).forEach(q => {
                                    log(`  ${q.subject.value} ${q.predicate.value} ${q.object.value}`, 'info');
                                });
                            }
                            
                            // Check for sh:property predicates
                            const propertyQuads = store.getQuads(shapeSubject, 'http://www.w3.org/ns/shacl#property', null, null);
                            log(`sh:property quads for shape: ${propertyQuads.length}`, propertyQuads.length > 0 ? 'success' : 'error');
                            
                            // Check total quads in shapes graph
                            const shapesGraphQuads = store.getQuads(null, null, null, 'loaded-shapes');
                            log(`Total quads in shapes graph (loaded-shapes): ${shapesGraphQuads.length}`, 'info');
                            
                            // Check total quads in data graph
                            const dataGraphQuads = store.getQuads(null, null, null, 'loaded-data');
                            log(`Total quads in data graph (loaded-data): ${dataGraphQuads.length}`, 'info');
                            
                            // Check if values subject has rdf:type
                            const valuesSubject = resolvedId;
                            const typeQuads = store.getQuads(valuesSubject, 'http://www.w3.org/1999/02/22-rdf-syntax-ns#type', null, 'loaded-data');
                            log(`rdf:type quads for values subject in loaded-data: ${typeQuads.length}`, typeQuads.length > 0 ? 'success' : 'error');
                            if (typeQuads.length > 0) {
                                typeQuads.forEach(q => {
                                    log(`  Type: ${q.object.value}`, 'info');
                                });
                            }
                        } else {
                            log('ERROR: Cannot access form.config.store', 'error');
                        }
                    } catch (e) {
                        log(`ERROR inspecting store: ${e.message}`, 'error');
                    }
                }, 500);

                // Check after delay
                setTimeout(() => {
                    log('=== CHECKING FORM STATE AFTER 3 SECONDS ===', 'info');
                    if (shaclFormElement.shadowRoot) {
                        log(`ShadowRoot innerHTML length: ${shaclFormElement.shadowRoot.innerHTML?.length}`, 'info');
                        log(`ShadowRoot children count: ${shaclFormElement.shadowRoot.children.length}`, 'info');
                        log(`First 500 chars: ${shaclFormElement.shadowRoot.innerHTML?.substring(0, 500)}`, 'info');
                        
                        // Check for shacl-property elements
                        const properties = shaclFormElement.shadowRoot.querySelectorAll('shacl-property');
                        const groups = shaclFormElement.shadowRoot.querySelectorAll('.shacl-group');
                        const nodes = shaclFormElement.shadowRoot.querySelectorAll('shacl-node');
                        log(`Found ${properties.length} shacl-property elements`, properties.length > 0 ? 'success' : 'error');
                        log(`Found ${groups.length} .shacl-group elements`, groups.length > 0 ? 'success' : 'error');
                        log(`Found ${nodes.length} shacl-node elements`, 'info');
                        
                        // Log details about the shacl-node
                        if (nodes.length > 0) {
                            const node = nodes[0];
                            log(`shacl-node data-node-id: ${node.getAttribute('data-node-id')}`, 'info');
                            log(`shacl-node innerHTML: ${node.innerHTML?.substring(0, 200)}`, 'info');
                            log(`shacl-node children count: ${node.children.length}`, 'info');
                        }
                        
                        if (properties.length === 0 && groups.length === 0) {
                            log('FORM IS EMPTY - NO CONTENT RENDERED', 'error');
                            log('This suggests the shape is found but properties are not being added', 'error');
                        }
                    } else {
                        log('ERROR: No shadowRoot found', 'error');
                    }
                }, 3000);

            } catch (error) {
                log(`EXCEPTION: ${error.message}`, 'error');
                log(`Stack: ${error.stack}`, 'error');
            }
        });

        // Auto-run on load
        log('Page loaded. Click "Run Test" to start.', 'info');
    </script>
</body>
</html>
